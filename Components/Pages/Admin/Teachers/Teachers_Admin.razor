@page "/Admin/Teachers"
@using System.Net.Http.Headers
@using System.Text.Json
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject IConfiguration Configuration
@inject NavigationManager Navigation

<GridRow>
    <GridCol Span="12">
        <PageHeader Class="site-page-header" Title="Teacher" Subtitle="教师信息" />
    </GridCol>   
    <GridCol Span="12" style="display: flex; justify-content: flex-end;">
        <Button Icon="download" OnClick="DownloadTemplate">
            <span>下载Excel模板</span>
        </Button>
        <Upload Action="@($"{Ip}/api/Teachers/UploadExcel")"
        Name="file"
        OnChange="Waiting"
        Accept=".xlsx"
        Headers="@(new Dictionary<string, string> { { "Authorization", "Bearer " + @Token! } })">
            <Button Icon="upload">
                <span>Excel 批量添加</span>
            </Button>
        </Upload>
    </GridCol> 
    <GridCol Span="4">
        <Input Type="number" Placeholder="学工号" Size="@InputSize.Default" @bind-Value="@Pagination.TeacherId">
            <Prefix>
                <Icon Type="user" />
            </Prefix>
        </Input>
    </GridCol>
    <GridCol Span="2" Style="margin-left:5px">
        <Button Type="@ButtonType.Primary">搜索</Button>
    </GridCol>
</GridRow>
<GridRow>
    <GridCol Span="24" Style="height:100vh;">
        <Table TItem="Teacher" DataSource="_teachers" @bind-PageSize="Pagination.PageSize">
            <ChildContent>
                @foreach (var column in _columns)
                {
                    <Column TData="object" DataIndex="@column"></Column>
                }
                <ActionColumn Title="Action">
                    <Space Size=@("middle")>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary">编辑</Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Danger Type="@ButtonType.Primary">删除</Button>
                        </SpaceItem>
                    </Space>
                </ActionColumn>
            </ChildContent>
            <PaginationTemplate>
                <Pagination Total="Pagination.Total"
                ShowSizeChanger="false"
                PageSize="Pagination.PageSize"
                Current="Pagination.Index" 
                OnChange="context.HandlePageChange" />
            </PaginationTemplate>
        </Table>
    </GridCol>   
</GridRow>


@if (_isUploading)
{
    <div class="overlay">
        <div class="loading-message">
            <Spin size="large" />耐心等待上传...
        </div>
    </div>
}

@code {
    protected override async void OnInitialized()
    {
        Token = (await LocalStorage.GetItemAsync<string>("jwtToken"))!;
        Ip = Configuration.GetSection("Ip")["Admin"];

        var jsonFilePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Test_Nav.json");
        var jsonData = await File.ReadAllTextAsync(jsonFilePath);
        _teachers = JsonSerializer.Deserialize<List<Teacher>>(jsonData);

        Pagination.Index = 1;
        Pagination.PageSize = 10;

        Pagination.Total = 4;
    }

    readonly string[] _columns = ["TeacherId", "UserId","Name", "Gender", "PhoneNumber", "Title", "Department", "Joining"];
    private List<Teacher>? _teachers;
    private string? Token { get; set; }
    private string? Ip { get; set; }
    private bool _isUploading = false;


    private async Task DownloadTemplate()
    {
        var url = $"{Ip}/api/Teachers/DownloadTemplate";
        using var client = new HttpClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", Token);

        var response = await client.GetAsync(url);

        if (response.IsSuccessStatusCode)
        {
            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var contentDisposition = response.Content.Headers.ContentDisposition;
            var fileName = contentDisposition?.FileName.Trim('"') ?? "default.xlsx";

            var base64 = Convert.ToBase64String(fileBytes);
            var blobUrl = $"data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}";

            Navigation.NavigateTo(blobUrl, true);
        }
    }

    private void Waiting()
    {
        _isUploading = !_isUploading;
    }

    private class Teacher
    {
        public string? TeacherId { get; set; }
        public string? UserId { get; set; }
        public string? Name { get; set; }
        public string? Gender { get; set; }
        public string? PhoneNumber { get; set; }
        public string? Title { get; set; }
        public string? Department { get; set; }
        public string? Joining { get; set; }
    }

    private static class Pagination
    {
        public static int Index { get; set; }
        public static int Total { get; set; }
        public static int PageSize { get; set; }
        public static int? TeacherId { get; set; }
    }

}
