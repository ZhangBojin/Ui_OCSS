@page "/Student/MyCourse"
@inject IMessageService _message
@using System.Net.Http.Headers
@using System.Text.Json
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject IConfiguration Configuration



@if (_hasLoadedData)
{
    <PageHeader Class="site-page-header" Title="导弹装配与维修" Subtitle="Missile assembly and maintenance" />
    <Divider />
}

@code {
    private string? Token { get; set; }
    private string? Ip { get; set; }
    private bool _hasLoadedData = false;

    private List<StdInfo>? StdInfos { get; set; }
    private CourseInfo? courseInfo { get; set; }



    [Parameter]
    public int CourseId { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasLoadedData)
        { var config = new MessageConfig()
            {
                Content = "加载数据中...",
                Key = $"updatable-{DateTime.Now.Ticks}"
            };
            _message.Loading(config);

            await LoadConfiguration();
            await GetCourseInfo(CourseId);
            await GetStuInfo(CourseId);
            _hasLoadedData = true;
            StateHasChanged();

            config.Content = "加载完成！";
            config.Duration = 1;
            await _message.Success(config);
        }
    }

    private async Task LoadConfiguration()
    {
        Token = (await LocalStorage.GetItemAsync<string>("jwtToken"))!;
        Ip = Configuration.GetSection("Ip")["ApiGateWay"];
    }

    private async Task GetStuInfo(int courseId)
    {
        var url = $"{Ip}/api/Course/GetStudentsInCoursesITeach?courseId={courseId}";

        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", Token);

        var response = await httpClient.PostAsync(url, null);

        if (response.IsSuccessStatusCode)
        {
            StdInfos = JsonSerializer.Deserialize<List<StdInfo>>(await response.Content.ReadAsStringAsync());
        }
    }

    private async Task GetCourseInfo(int courseId)
    {
        var url = $"{Ip}/api/Course/GetCourseInfo?courseId={courseId}";

        using var httpClient = new HttpClient();
        httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", Token);

        var response = await httpClient.PostAsync(url, null);

        if (response.IsSuccessStatusCode)
        {
            courseInfo = JsonSerializer.Deserialize<CourseInfo>(await response.Content.ReadAsStringAsync());
        }
    }

    private class StdInfo
    {
        public int userId { get; set; }
        public int studentId { get; set; }
        public string? name { get; set; }
        public string? gender { get; set; }
        public string? major { get; set; }
        public string? email { get; set; }

        public float? grade { get; set; }
        public bool? isPass { get; set; }
    }

    private class CourseInfo
    {
        public int id { get; set; }
        public string? name { get; set; }
        public string? teacherName { get; set; }
        public float? credits { get; set; }
    }
}